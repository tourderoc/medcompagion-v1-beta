<UserControl x:Class="MedCompanion.Views.Ordonnances.MedicamentsControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:converters="clr-namespace:MedCompanion.Converters"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="800">

    <UserControl.Resources>
        <converters:CountToVisibilityConverter x:Key="CountToVisibilityConverter"/>
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
    </UserControl.Resources>

    <Grid Margin="0,10,0,0">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="15"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="15"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Avertissement base BDPM non initialisÃ©e -->
        <Border x:Name="WarningBDPMBorder"
                Grid.Row="0"
                Background="#FFF3CD"
                BorderBrush="#FFC107"
                BorderThickness="1"
                CornerRadius="6"
                Padding="15"
                Visibility="Collapsed">
            <StackPanel>
                <TextBlock FontSize="13" FontWeight="SemiBold" Foreground="#856404">
                    <Run Text="âš ï¸ Base BDPM non initialisÃ©e"/>
                </TextBlock>
                <TextBlock FontSize="11" Foreground="#856404" Margin="0,5,0,10" TextWrapping="Wrap">
                    <Run Text="Pour utiliser l'autocomplÃ©tion des mÃ©dicaments, vous devez d'abord importer la base de donnÃ©es BDPM (Base de DonnÃ©es Publique des MÃ©dicaments)."/>
                </TextBlock>
                <Button x:Name="InitBDPMButton"
                        Content="ðŸ“¥ VÃ©rifier / Importer la base BDPM"
                        Height="35"
                        Padding="15,0"
                        FontSize="12"
                        FontWeight="SemiBold"
                        Background="#28A745"
                        Foreground="White"
                        BorderThickness="0"
                        Cursor="Hand"
                        Click="InitBDPMButton_Click">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border Background="{TemplateBinding Background}" CornerRadius="6">
                                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Border>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#218838"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>
            </StackPanel>
        </Border>

        <!-- Interface principale -->
        <Grid x:Name="MainInterfaceGrid" Grid.Row="2" Visibility="Collapsed">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="12"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="15"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="15"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Bouton Renouveler ordonnance -->
            <Button x:Name="RenewOrdonnanceButton"
                    Grid.Row="0"
                    Content="ðŸ”„ Renouveler la derniÃ¨re ordonnance"
                    Height="36"
                    Background="#3498DB"
                    Foreground="White"
                    FontWeight="SemiBold"
                    FontSize="12"
                    BorderBrush="#2980B9"
                    BorderThickness="1"
                    IsEnabled="False"
                    Click="RenewOrdonnanceButton_Click">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="Button">
                                    <Border Background="{TemplateBinding Background}"
                                            BorderBrush="{TemplateBinding BorderBrush}"
                                            BorderThickness="{TemplateBinding BorderThickness}"
                                            CornerRadius="6">
                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    </Border>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                        <Style.Triggers>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Background" Value="#BDC3C7"/>
                                <Setter Property="BorderBrush" Value="#95A5A6"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#2980B9"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>

            <!-- Recherche mÃ©dicament -->
            <Border Grid.Row="2" BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="6" Background="White">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="10"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="10"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0"
                              Text="ðŸ” Rechercher un mÃ©dicament"
                              FontSize="13"
                              FontWeight="SemiBold"
                              Foreground="#2C3E50"
                              Margin="15,15,15,0"/>

                    <!-- Zone de recherche -->
                    <Grid Grid.Row="2" Margin="15,0,15,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="10"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <Border Grid.Column="0"
                               BorderBrush="#BDC3C7"
                               BorderThickness="1"
                               CornerRadius="6"
                               Background="White">
                            <TextBox x:Name="SearchTextBox"
                                    Height="40"
                                    FontSize="14"
                                    Padding="10"
                                    VerticalContentAlignment="Center"
                                    BorderThickness="0"
                                    Foreground="#2C3E50"
                                    Background="Transparent"
                                    CaretBrush="#2C3E50"
                                    TextChanged="SearchTextBox_TextChanged"/>
                        </Border>

                        <TextBlock Grid.Column="0"
                                  Text="Tapez au moins 3 lettres..."
                                  FontSize="14"
                                  Foreground="#95A5A6"
                                  VerticalAlignment="Center"
                                  Margin="15,0,0,0"
                                  IsHitTestVisible="False">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding Text, ElementName=SearchTextBox}" Value="">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>

                        <Button x:Name="ClearSearchButton"
                               Grid.Column="2"
                               Content="âŒ Effacer"
                               Height="40"
                               Padding="15,0"
                               FontSize="12"
                               Background="#E74C3C"
                               Foreground="White"
                               BorderThickness="0"
                               Cursor="Hand"
                               Click="ClearSearchButton_Click">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Button">
                                                <Border Background="{TemplateBinding Background}" CornerRadius="6">
                                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                </Border>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#C0392B"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                    </Grid>

                    <!-- RÃ©sultats de recherche (autocomplÃ©tion) -->
                    <Border x:Name="SearchResultsBorder"
                           Grid.Row="4"
                           Margin="15,0,15,15"
                           BorderBrush="#E0E0E0"
                           BorderThickness="1"
                           CornerRadius="6"
                           MaxHeight="300"
                           Visibility="Collapsed">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <ListBox x:Name="SearchResultsList"
                                    BorderThickness="0"
                                    Background="Transparent"
                                    ScrollViewer.VerticalScrollBarVisibility="Disabled"
                                    SelectionChanged="SearchResultsList_SelectionChanged">
                                <ListBox.ItemContainerStyle>
                                    <Style TargetType="ListBoxItem">
                                        <Setter Property="Padding" Value="10"/>
                                        <Setter Property="Margin" Value="2"/>
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="ListBoxItem">
                                                    <Border x:Name="Border"
                                                           Background="{TemplateBinding Background}"
                                                           Padding="{TemplateBinding Padding}"
                                                           BorderBrush="Transparent"
                                                           BorderThickness="1">
                                                        <ContentPresenter/>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter TargetName="Border" Property="Background" Value="#E8F4F8"/>
                                                        </Trigger>
                                                        <Trigger Property="IsSelected" Value="True">
                                                            <Setter TargetName="Border" Property="Background" Value="#D4E6F1"/>
                                                            <Setter TargetName="Border" Property="BorderBrush" Value="#3498DB"/>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </ListBox.ItemContainerStyle>
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel>
                                            <TextBlock Text="{Binding Denomination}"
                                                      FontSize="12"
                                                      FontWeight="SemiBold"
                                                      Foreground="#2C3E50"/>
                                            <TextBlock FontSize="10" Foreground="#7F8C8D" Margin="0,2,0,0">
                                                <Run Text="{Binding Forme}"/>
                                                <Run Text=" - "/>
                                                <Run Text="{Binding VoieAdministration}"/>
                                            </TextBlock>
                                            <!-- Afficher la premiÃ¨re prÃ©sentation si disponible -->
                                            <TextBlock Text="{Binding Presentations[0].Libelle}"
                                                      FontSize="10"
                                                      Foreground="#16A085"
                                                      Margin="0,2,0,0"
                                                      Visibility="{Binding Presentations.Count, Converter={StaticResource CountToVisibilityConverter}}"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </ScrollViewer>
                    </Border>
                </Grid>
            </Border>

            <!-- Formulaire d'ajout mÃ©dicament -->
            <Border x:Name="AddMedicamentBorder"
                   Grid.Row="4"
                   BorderBrush="#E0E0E0"
                   BorderThickness="1"
                   CornerRadius="6"
                   Background="#F8F9FA"
                   Padding="15"
                   Visibility="Collapsed">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="10"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="10"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="10"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="10"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0"
                              x:Name="SelectedMedicamentLabel"
                              FontSize="13"
                              FontWeight="Bold"
                              Foreground="#2C3E50"/>

                    <TextBlock Grid.Row="2" Text="Posologie :" FontSize="11" Foreground="#5D6D7E"/>
                    <TextBox x:Name="PosologieTextBox"
                            Grid.Row="2"
                            Height="35"
                            FontSize="12"
                            Padding="8"
                            Margin="0,20,0,0"
                            BorderBrush="#BDC3C7"
                            BorderThickness="1"/>

                    <Grid Grid.Row="4">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="10"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <TextBlock Text="DurÃ©e :" FontSize="11" Foreground="#5D6D7E"/>
                            <TextBox x:Name="DureeTextBox"
                                    Height="35"
                                    FontSize="12"
                                    Padding="8"
                                    Margin="0,5,0,0"
                                    BorderBrush="#BDC3C7"
                                    BorderThickness="1"/>
                        </StackPanel>

                        <StackPanel Grid.Column="2">
                            <TextBlock Text="QuantitÃ© :" FontSize="11" Foreground="#5D6D7E"/>
                            <TextBox x:Name="QuantiteTextBox"
                                    Height="35"
                                    FontSize="12"
                                    Padding="8"
                                    Margin="0,5,0,0"
                                    Text="1"
                                    BorderBrush="#BDC3C7"
                                    BorderThickness="1"/>
                        </StackPanel>
                    </Grid>

                    <CheckBox x:Name="RenouvelableCheckBox"
                             Grid.Row="6"
                             Content="Renouvellement autorisÃ©"
                             FontSize="11"
                             Foreground="#5D6D7E"
                             Checked="RenouvelableCheckBox_Checked"
                             Unchecked="RenouvelableCheckBox_Unchecked"/>

                    <StackPanel x:Name="RenouvellementPanel"
                               Grid.Row="6"
                               Orientation="Horizontal"
                               Margin="0,25,0,0"
                               Visibility="Collapsed">
                        <TextBlock Text="Nombre de renouvellements :"
                                  FontSize="11"
                                  Foreground="#5D6D7E"
                                  VerticalAlignment="Center"
                                  Margin="0,0,10,0"/>
                        <TextBox x:Name="NombreRenouvellementTextBox"
                                Width="60"
                                Height="30"
                                FontSize="12"
                                Padding="5"
                                Text="0"
                                BorderBrush="#BDC3C7"
                                BorderThickness="1"/>
                    </StackPanel>

                    <StackPanel Grid.Row="8" Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button x:Name="CancelAddButton"
                               Content="âŒ Annuler"
                               Height="35"
                               Padding="15,0"
                               FontSize="12"
                               Background="#95A5A6"
                               Foreground="White"
                               BorderThickness="0"
                               Margin="0,0,10,0"
                               Cursor="Hand"
                               Click="CancelAddButton_Click">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Button">
                                                <Border Background="{TemplateBinding Background}" CornerRadius="6">
                                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                </Border>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#7F8C8D"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>

                        <Button x:Name="AddToOrdonnanceButton"
                               Content="âž• Ajouter Ã  l'ordonnance"
                               Height="35"
                               Padding="15,0"
                               FontSize="12"
                               FontWeight="SemiBold"
                               Background="#28A745"
                               Foreground="White"
                               BorderThickness="0"
                               Cursor="Hand"
                               Click="AddToOrdonnanceButton_Click">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Button">
                                                <Border Background="{TemplateBinding Background}" CornerRadius="6">
                                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                </Border>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#218838"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Liste des mÃ©dicaments prescrits -->
            <Grid Grid.Row="6">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="10"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="10"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0"
                          Text="ðŸ’Š MÃ©dicaments prescrits"
                          FontSize="13"
                          FontWeight="SemiBold"
                          Foreground="#2C3E50"/>

                <Border Grid.Row="2" BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="6" MaxHeight="400">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ListBox x:Name="MedicamentsPrescritsList"
                                BorderThickness="0"
                                Background="Transparent"
                                ScrollViewer.VerticalScrollBarVisibility="Disabled">
                            <ListBox.ItemContainerStyle>
                                <Style TargetType="ListBoxItem">
                                    <Setter Property="Padding" Value="10"/>
                                    <Setter Property="Margin" Value="4,2,4,4"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="ListBoxItem">
                                                <Border x:Name="Border"
                                                       Background="{TemplateBinding Background}"
                                                       Padding="{TemplateBinding Padding}"
                                                       BorderBrush="#E0E0E0"
                                                       BorderThickness="1"
                                                       CornerRadius="6">
                                                    <ContentPresenter/>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter TargetName="Border" Property="Background" Value="#F0F8FF"/>
                                                        <Setter TargetName="Border" Property="BorderBrush" Value="#3498DB"/>
                                                    </Trigger>
                                                    <Trigger Property="IsSelected" Value="True">
                                                        <Setter TargetName="Border" Property="Background" Value="#E8F4F8"/>
                                                        <Setter TargetName="Border" Property="BorderBrush" Value="#3498DB"/>
                                                        <Setter TargetName="Border" Property="BorderThickness" Value="2"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </ListBox.ItemContainerStyle>
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="10"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <StackPanel Grid.Column="0">
                                            <TextBlock Text="{Binding Medicament.Denomination}"
                                                      FontSize="12"
                                                      FontWeight="Bold"
                                                      Foreground="#2C3E50"/>
                                            <TextBlock Text="{Binding Presentation.Libelle}"
                                                      FontSize="10"
                                                      Foreground="#16A085"
                                                      Margin="0,2,0,0"
                                                      Visibility="{Binding Presentation, Converter={StaticResource NullToVisibilityConverter}}"/>
                                            <TextBlock FontSize="10" Foreground="#5D6D7E" Margin="0,4,0,0">
                                                <Run Text="Posologie : "/>
                                                <Run Text="{Binding Posologie}" FontWeight="SemiBold"/>
                                            </TextBlock>
                                            <TextBlock FontSize="10" Foreground="#5D6D7E" Margin="0,2,0,0">
                                                <Run Text="DurÃ©e : "/>
                                                <Run Text="{Binding Duree}"/>
                                                <Run Text=" - QuantitÃ© : "/>
                                                <Run Text="{Binding Quantite}"/>
                                            </TextBlock>
                                        </StackPanel>

                                        <Button Grid.Column="2"
                                               Content="ðŸ—‘ï¸"
                                               Width="35"
                                               Height="35"
                                               FontSize="16"
                                               Background="#E74C3C"
                                               Foreground="White"
                                               BorderThickness="0"
                                               Cursor="Hand"
                                               Click="RemoveMedicamentButton_Click"
                                               Tag="{Binding}">
                                            <Button.Style>
                                                <Style TargetType="Button">
                                                    <Setter Property="Template">
                                                        <Setter.Value>
                                                            <ControlTemplate TargetType="Button">
                                                                <Border Background="{TemplateBinding Background}" CornerRadius="6">
                                                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                                </Border>
                                                            </ControlTemplate>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Style.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Background" Value="#C0392B"/>
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Button.Style>
                                        </Button>
                                    </Grid>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </ScrollViewer>
                </Border>

                <!-- Bouton GÃ©nÃ©rer l'ordonnance -->
                <Button x:Name="GenererOrdonnanceButton"
                       Grid.Row="4"
                       Content="ðŸ“„ GÃ©nÃ©rer l'ordonnance"
                       Height="45"
                       FontSize="14"
                       FontWeight="Bold"
                       Background="#3498DB"
                       Foreground="White"
                       BorderThickness="0"
                       Cursor="Hand"
                       Click="GenererOrdonnanceButton_Click"
                       IsEnabled="False">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border Background="{TemplateBinding Background}" CornerRadius="8">
                                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Border>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#2980B9"/>
                                </Trigger>
                                <Trigger Property="IsEnabled" Value="False">
                                    <Setter Property="Background" Value="#BDC3C7"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>
            </Grid>
        </Grid>
    </Grid>
</UserControl>
