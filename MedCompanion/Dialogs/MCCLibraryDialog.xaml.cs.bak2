using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using MedCompanion.Models;
using MedCompanion.Services;
using MedCompanion.Services.LLM;

namespace MedCompanion.Dialogs;

public partial class MCCLibraryDialog : Window
{
    private readonly MCCLibraryService _mccLibrary;
    private readonly LetterRatingService _ratingService;
    private List<MCCDisplayItem> _allMCCs = new();
    private List<MCCDisplayItem> _filteredMCCs = new();
    private MCCModel? _selectedMCC;
    
    public MCCModel? SelectedMCC => _selectedMCC;
    public bool ShouldGenerate { get; private set; }
    
    public MCCLibraryDialog(MCCLibraryService mccLibrary, LetterRatingService? ratingService = null)
    {
        InitializeComponent();
        _mccLibrary = mccLibrary;
        _ratingService = ratingService ?? new LetterRatingService();
        Loaded += MCCLibraryDialog_Loaded;
    }
    
    private void MCCLibraryDialog_Loaded(object sender, RoutedEventArgs e)
    {
        LoadMCCs();
    }
    
    private void LoadMCCs()
    {
        try
        {
            var mccs = _mccLibrary.GetAllMCCs();
            
            _allMCCs = mccs.Select(mcc =>
            {
                // R√©cup√©rer les statistiques de notation pour ce MCC
                var stats = _ratingService.GetMCCStatistics(mcc.Id);
                
                return new MCCDisplayItem
                {
                    MCC = mcc,
                    Name = mcc.Name,
                    CreatedDisplay = mcc.Created.ToString("dd/MM/yyyy"),
                    UsageCount = mcc.UsageCount,
                    KeywordsPreview = mcc.Keywords != null && mcc.Keywords.Count > 0
                        ? string.Join(", ", mcc.Keywords.Take(3)) + (mcc.Keywords.Count > 3 ? "..." : "")
                        : "Aucun",
                    Semantic = mcc.Semantic ?? new SemanticAnalysis(),
                    // üÜï Statistiques de notation
                    AverageRating = stats.AverageRating,
                    RatingCount = stats.TotalRatings,
                    RatingDisplay = FormatRatingDisplay(stats),
                    RatingColor = GetRatingColor(stats.AverageRating, stats.TotalRatings)
                };
            }).ToList();
            
            _filteredMCCs = new List<MCCDisplayItem>(_allMCCs);
            UpdateList();
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Erreur chargement MCC :\n\n{ex.Message}", "Erreur",
                MessageBoxButton.OK, MessageBoxImage.Error);
        }
    }
    
    private void UpdateList()
    {
        MCCListBox.ItemsSource = null;
        MCCListBox.ItemsSource = _filteredMCCs;
        
        var count = _filteredMCCs.Count;
        CountLabel.Text = count == 0 ? "Aucun MCC" :
                         count == 1 ? "1 MCC" :
                         $"{count} MCCs";
    }
    
    private void SearchBox_TextChanged(object sender, TextChangedEventArgs e)
    {
        var query = SearchBox.Text.Trim().ToLower();
        
        if (string.IsNullOrEmpty(query))
        {
            _filteredMCCs = new List<MCCDisplayItem>(_allMCCs);
        }
        else
        {
            _filteredMCCs = _allMCCs.Where(mcc =>
                mcc.Name.ToLower().Contains(query) ||
                (mcc.MCC.Keywords != null && mcc.MCC.Keywords.Any(k => k.ToLower().Contains(query))) ||
                (mcc.MCC.Semantic?.DocType?.ToLower().Contains(query) ?? false) ||
                (mcc.MCC.Semantic?.Audience?.ToLower().Contains(query) ?? false)
            ).ToList();
        }
        
        UpdateList();
    }
    
    private void MCCListBox_SelectionChanged(object sender, SelectionChangedEventArgs e)
    {
        if (MCCListBox.SelectedItem is MCCDisplayItem displayItem)
        {
            _selectedMCC = displayItem.MCC;
            DisplayMCCDetails(displayItem.MCC);

            // Activer les boutons
            EditButton.IsEnabled = true;
            GenerateButton.IsEnabled = true;
            DeleteButton.IsEnabled = true;
            OptimizeButton.IsEnabled = true;

            // G√©rer les boutons Ajouter/Retirer selon l'√©tat
            if (_selectedMCC.IsInCourriersList)
            {
                // MCC d√©j√† dans la liste ‚Üí Afficher "Retirer"
                AddToCourriersButton.Visibility = Visibility.Collapsed;
                RemoveFromCourriersButton.Visibility = Visibility.Visible;
                RemoveFromCourriersButton.IsEnabled = true;
            }
            else
            {
                // MCC pas dans la liste ‚Üí Afficher "Ajouter"
                AddToCourriersButton.Visibility = Visibility.Visible;
                AddToCourriersButton.IsEnabled = true;
                RemoveFromCourriersButton.Visibility = Visibility.Collapsed;
            }
        }
        else
        {
            _selectedMCC = null;
            ClearDetails();

            // D√©sactiver les boutons
            EditButton.IsEnabled = false;
            GenerateButton.IsEnabled = false;
            DeleteButton.IsEnabled = false;
            OptimizeButton.IsEnabled = false;
            AddToCourriersButton.IsEnabled = false;
            RemoveFromCourriersButton.IsEnabled = false;
        }
    }
    
    private void DisplayMCCDetails(MCCModel mcc)
    {
        // En-t√™te
        PreviewTitle.Text = mcc.Name;
        PreviewSubtitle.Text = mcc.Semantic != null
            ? $"{mcc.Semantic.DocType} ‚Ä¢ {mcc.Semantic.Audience}"
            : "Informations s√©mantiques non disponibles";
        
        // Stats
        UsageStats.Text = $"üìä {mcc.UsageCount} utilisations";
        DateStats.Text = $"üìÖ Cr√©√© le {mcc.Created:dd/MM/yyyy}";
        if (mcc.LastModified != mcc.Created)
        {
            DateStats.Text += $"\n‚úèÔ∏è Modifi√© le {mcc.LastModified:dd/MM/yyyy}";
        }
        
        // Template
        TemplatePreview.Text = mcc.TemplateMarkdown ?? "Template non disponible";
        
        // Variables - EXTRAIRE depuis le template Markdown
        var variables = ExtractVariablesFromTemplate(mcc.TemplateMarkdown);
        if (variables.Count > 0)
        {
            VariablesText.Text = string.Join(", ", variables.Select(v => $"{{{{{v}}}}}"));
        }
        else
        {
            VariablesText.Text = "Aucune variable d√©tect√©e";
        }
        
        // Analyse s√©mantique
        // üÜï Afficher les √©valuations
        var stats = _ratingService.GetMCCStatistics(mcc.Id);
        if (stats.TotalRatings > 0)
        {
            RatingStarsText.Text = GetStarDisplay(stats.AverageRating);
            RatingAverageText.Text = $"{stats.AverageRating:F1}/5";
            RatingCountText.Text = $"({stats.TotalRatings} {(stats.TotalRatings > 1 ? "√©valuations" : "√©valuation")})";
            RatingSatisfactionText.Text = $"Satisfaction : {stats.SatisfactionRate:F0}%";
            
            // Distribution des notes
            RatingDistributionText.Text = $"5‚òÖ ({stats.FiveStars}) ‚Ä¢ 4‚òÖ ({stats.FourStars}) ‚Ä¢ 3‚òÖ ({stats.ThreeStars}) ‚Ä¢ 2‚òÖ ({stats.TwoStars}) ‚Ä¢ 1‚òÖ ({stats.OneStar})";
            
            // Afficher la section
            RatingSection.Visibility = Visibility.Visible;
        }
        else
        {
            RatingSection.Visibility = Visibility.Collapsed;
        }
        
        if (mcc.Semantic != null)
        {
            SemanticType.Text = mcc.Semantic.DocType ?? "-";
            SemanticAudience.Text = mcc.Semantic.Audience ?? "-";
            SemanticAge.Text = mcc.Semantic.AgeGroup ?? "-";
            SemanticTone.Text = mcc.Semantic.Tone ?? "-";
            
            // Mots-cl√©s - Afficher les mots-cl√©s optimis√©s du MCC
            if (mcc.Keywords != null && mcc.Keywords.Count > 0)
            {
                KeywordsList.ItemsSource = mcc.Keywords;
            }
            else
            {
                KeywordsList.ItemsSource = new List<string> { "Aucun" };
            }
            
            // Structure
            if (mcc.Semantic.Sections != null && mcc.Semantic.Sections.Count > 0)
            {
                StructureList.ItemsSource = mcc.Semantic.Sections.ToList();
            }
            else
            {
                StructureList.ItemsSource = new List<KeyValuePair<string, string>>
                {
                    new KeyValuePair<string, string>("Structure", "Non analys√©e")
                };
            }
        }
        else
        {
            SemanticType.Text = "Non disponible";
            SemanticAudience.Text = "-";
            SemanticAge.Text = "-";
            SemanticTone.Text = "-";
            KeywordsList.ItemsSource = new List<string> { "Non disponible" };
            StructureList.ItemsSource = new List<KeyValuePair<string, string>>();
        }
    }
    
    private void ClearDetails()
    {
        PreviewTitle.Text = "S√©lectionnez un MCC";
        PreviewSubtitle.Text = "";
        UsageStats.Text = "üìä 0 utilisations";
        DateStats.Text = "";
        TemplatePreview.Text = "S√©lectionnez un MCC dans la liste pour voir son aper√ßu...";
        VariablesText.Text = "Aucune";
        
        SemanticType.Text = "-";
        SemanticAudience.Text = "-";
        SemanticAge.Text = "-";
        SemanticTone.Text = "-";
        KeywordsList.ItemsSource = null;
        StructureList.ItemsSource = null;
    }
    
    private void RefreshButton_Click(object sender, RoutedEventArgs e)
    {
        LoadMCCs();
        MessageBox.Show("Liste rafra√Æchie !", "Info", MessageBoxButton.OK, MessageBoxImage.Information);
    }
    
    private void GenerateButton_Click(object sender, RoutedEventArgs e)
    {
        if (_selectedMCC == null)
        {
            MessageBox.Show("Veuillez s√©lectionner un MCC.", "Info", 
                MessageBoxButton.OK, MessageBoxImage.Information);
            return;
        }
        
        // Incr√©menter le compteur d'utilisation
        _selectedMCC.UsageCount++;
        _mccLibrary.UpdateMCC(_selectedMCC);
        
        ShouldGenerate = true;
        DialogResult = true;
        Close();
    }
    
    private void EditButton_Click(object sender, RoutedEventArgs e)
    {
        if (_selectedMCC == null)
        {
            MessageBox.Show("Veuillez s√©lectionner un MCC √† √©diter.", "Info",
                MessageBoxButton.OK, MessageBoxImage.Information);
            return;
        }

        try
        {
            // Sauvegarder l'ID avant d'ouvrir le dialogue
            var mccId = _selectedMCC.Id;
            
            // Ouvrir le dialogue d'√©dition
            var editDialog = new EditMCCDialog(_selectedMCC, _mccLibrary)
            {
                Owner = this
            };

            var result = editDialog.ShowDialog();

            if (result == true)
            {
                // Rafra√Æchir la liste pour afficher les modifications
                LoadMCCs();

                // Res√©lectionner le MCC √©dit√© en utilisant l'ID sauvegard√©
                var displayItem = _allMCCs.FirstOrDefault(d => d.MCC != null && d.MCC.Id == mccId);
                if (displayItem != null && displayItem.MCC != null)
                {
                    _selectedMCC = displayItem.MCC;
                    MCCListBox.SelectedItem = displayItem;
                    DisplayMCCDetails(_selectedMCC);
                }
                else
                {
                    // Si on ne peut pas res√©lectionner, juste effacer la s√©lection
                    _selectedMCC = null;
                    MCCListBox.SelectedItem = null;
                    ClearDetails();
                }
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Erreur lors de l'√©dition:\n\n{ex.Message}\n\nStack: {ex.StackTrace}", "Erreur",
                MessageBoxButton.OK, MessageBoxImage.Error);
        }
    }
    
    private void DeleteButton_Click(object sender, RoutedEventArgs e)
    {
        if (_selectedMCC == null)
        {
            MessageBox.Show("Veuillez s√©lectionner un MCC.", "Info", 
                MessageBoxButton.OK, MessageBoxImage.Information);
            return;
        }
        
        var result = MessageBox.Show(
            $"√ätes-vous s√ªr de vouloir supprimer ce MCC ?\n\n" +
            $"Nom : {_selectedMCC.Name}\n" +
            $"Utilisations : {_selectedMCC.UsageCount}\n\n" +
            "Cette action est irr√©versible.",
            "Confirmer la suppression",
            MessageBoxButton.YesNo,
            MessageBoxImage.Warning
        );
        
        if (result == MessageBoxResult.Yes)
        {
            var (success, message) = _mccLibrary.DeleteMCC(_selectedMCC.Id);
            
            if (success)
            {
                MessageBox.Show("‚úÖ MCC supprim√© avec succ√®s", "Succ√®s",
                    MessageBoxButton.OK, MessageBoxImage.Information);
                LoadMCCs();
            }
            else
            {
                MessageBox.Show($"‚ùå Erreur : {message}", "Erreur",
                    MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }
    }
    
    private async void OptimizeButton_Click(object sender, RoutedEventArgs e)
    {
        if (_selectedMCC == null)
        {
            MessageBox.Show("Veuillez s√©lectionner un MCC √† optimiser.", "Info",
                MessageBoxButton.OK, MessageBoxImage.Information);
            return;
        }

        // V√©rifier si le MCC a un template valide
        if (string.IsNullOrWhiteSpace(_selectedMCC.TemplateMarkdown))
        {
            MessageBox.Show("Ce MCC n'a pas de template valide √† optimiser.", "Info",
                MessageBoxButton.OK, MessageBoxImage.Information);
            return;
        }

        // Demander confirmation
        var result = MessageBox.Show(
            $"√ätes-vous s√ªr de vouloir optimiser ce MCC avec l'IA ?\n\n" +
            $"Nom : {_selectedMCC.Name}\n" +
            $"Version actuelle : {_selectedMCC.Version}\n\n" +
            "L'optimisation va :\n" +
            "‚Ä¢ Nettoyer et am√©liorer le template\n" +
            "‚Ä¢ R√©g√©n√©rer les 5 mots-cl√©s\n" +
            "‚Ä¢ Affiner l'analyse s√©mantique\n" +
            "‚Ä¢ Incr√©menter la version\n\n" +
            "Cette action est irr√©versible.",
            "Confirmer l'optimisation IA",
            MessageBoxButton.YesNo,
            MessageBoxImage.Question
        );

        if (result != MessageBoxResult.Yes)
            return;

        try
        {
            // D√©sactiver le bouton pendant l'optimisation
            OptimizeButton.IsEnabled = false;
            OptimizeButton.Content = "üß† Optimisation en cours...";

            // Obtenir le service LLM depuis la fen√™tre principale
            var mainWindow = Application.Current.MainWindow as MainWindow;
            if (mainWindow == null)
            {
                MessageBox.Show("Erreur: Fen√™tre principale non trouv√©e.", "Erreur",
                    MessageBoxButton.OK, MessageBoxImage.Error);
                return;
            }

            // R√©cup√©rer le service LLM actuel
            var llmService = mainWindow.GetCurrentLLMService();
            if (llmService == null)
            {
                MessageBox.Show("Service IA non disponible. V√©rifiez la configuration.", "Erreur",
                    MessageBoxButton.OK, MessageBoxImage.Error);
                return;
            }

            // Optimiser le MCC
            var (success, message, optimizationResponse) = await _mccLibrary.OptimizeMCCAsync(_selectedMCC.Id, llmService);

            if (!success || optimizationResponse == null)
            {
                MessageBox.Show($"‚ùå Erreur lors de l'optimisation:\n\n{message}", "Erreur",
                    MessageBoxButton.OK, MessageBoxImage.Error);
                return;
            }

            // Demander confirmation avant d'appliquer
            var applyResult = MessageBox.Show(
                $"‚úÖ Optimisation r√©ussie !\n\n{message}\n\n" +
                $"Nouveaux mots-cl√©s: {string.Join(", ", optimizationResponse.Keywords)}\n\n" +
                "Voulez-vous appliquer ces optimisations au MCC ?",
                "Appliquer l'optimisation",
                MessageBoxButton.YesNo,
                MessageBoxImage.Question
            );

            if (applyResult == MessageBoxResult.Yes)
            {
                // Sauvegarder l'ID avant l'application
                var mccId = _selectedMCC.Id;
                
                // Appliquer l'optimisation
                var (applySuccess, applyMessage) = _mccLibrary.ApplyOptimization(mccId, optimizationResponse);

                if (applySuccess)
                {
                    MessageBox.Show($"‚úÖ {applyMessage}", "Succ√®s",
                        MessageBoxButton.OK, MessageBoxImage.Information);

                    // Rafra√Æchir l'affichage
                    LoadMCCs();

                    // Res√©lectionner le MCC optimis√© en utilisant l'ID sauvegard√©
                    var displayItem = _allMCCs.FirstOrDefault(d => d.MCC?.Id == mccId);
                    if (displayItem != null && displayItem.MCC != null)
                    {
                        _selectedMCC = displayItem.MCC;
                        MCCListBox.SelectedItem = displayItem;
                        DisplayMCCDetails(_selectedMCC);
                    }
                    else
                    {
                        // Si on ne peut pas res√©lectionner, juste effacer la s√©lection
                        _selectedMCC = null;
                        MCCListBox.SelectedItem = null;
                        ClearDetails();
                    }
                }
                else
                {
                    MessageBox.Show($"‚ùå Erreur lors de l'application:\n\n{applyMessage}", "Erreur",
                        MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Erreur inattendue:\n\n{ex.Message}", "Erreur",
                MessageBoxButton.OK, MessageBoxImage.Error);
        }
        finally
        {
            // R√©activer le bouton
            OptimizeButton.IsEnabled = true;
            OptimizeButton.Content = "üß† Optimiser le MCC";
        }
    }

    /// <summary>
    /// Extrait les variables d'un template en d√©tectant les placeholders {{Variable}}
    /// </summary>
    private List<string> ExtractVariablesFromTemplate(string? templateContent)
    {
        if (string.IsNullOrWhiteSpace(templateContent))
            return new List<string>();

        var matches = System.Text.RegularExpressions.Regex.Matches(templateContent, @"\{\{([^}]+)\}\}");
        return matches
            .Cast<System.Text.RegularExpressions.Match>()
            .Select(m => m.Groups[1].Value.Trim())
            .Distinct()
            .OrderBy(v => v)
            .ToList();
    }
    
    /// <summary>
    /// Formate l'affichage de la note pour les cartes MCC
    /// </summary>
    private string FormatRatingDisplay(MCCStatistics stats)
    {
        if (stats.TotalRatings == 0)
            return "Aucune √©valuation";
        
        var label = stats.AverageRating >= 4.5 ? "Excellent" :
                    stats.AverageRating >= 3.5 ? "Bon" :
                    stats.AverageRating >= 2.5 ? "√Ä am√©liorer" :
                    "√Ä revoir";
        
        return $"‚≠ê {stats.AverageRating:F1} ({stats.TotalRatings}) ‚Ä¢ {label}";
    }
    
    /// <summary>
    /// Retourne la couleur selon la note moyenne
    /// </summary>
    private string GetRatingColor(double average, int count)
    {
        if (count == 0)
            return "#999999"; // Gris
        
        if (average >= 4.0)
            return "#27AE60"; // Vert
        else if (average >= 3.0)
            return "#F39C12"; // Orange
        else
            return "#E74C3C"; // Rouge
    }
    
    /// <summary>
    /// Affiche les √©toiles selon la note moyenne
    /// </summary>
    private string GetStarDisplay(double average)
    {
        var fullStars = (int)Math.Floor(average);
        var hasHalfStar = (average - fullStars) >= 0.5;
        var emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

        var stars = new string('‚òÖ', fullStars);
        if (hasHalfStar) stars += "‚Ø®";
        stars += new string('‚òÜ', emptyStars);

        return stars;
    }

    /// <summary>
    /// Ajoute le MCC s√©lectionn√© √† la liste Courriers
    /// </summary>
    private void AddToCourriersList_Click(object sender, RoutedEventArgs e)
    {
        try
        {
            if (_selectedMCC == null)
            {
                MessageBox.Show("Veuillez s√©lectionner un MCC.", "Info",
                    MessageBoxButton.OK, MessageBoxImage.Information);
                return;
            }

            var mccId = _selectedMCC.Id; // Sauvegarder l'ID AVANT le rechargement
            var mccName = _selectedMCC.Name;
            System.Diagnostics.Debug.WriteLine($"[AddToCourriers] Ajout du MCC: {mccName} (ID: {mccId})");

            var (success, message) = _mccLibrary.AddToCourriersList(mccId);

            if (success)
            {
                MessageBox.Show(message, "Succ√®s",
                    MessageBoxButton.OK, MessageBoxImage.Information);

                // Rafra√Æchir l'affichage
                LoadMCCs();

                // Res√©lectionner le MCC en utilisant l'ID sauvegard√©
                var displayItem = _allMCCs.FirstOrDefault(d => d.MCC?.Id == mccId);
                if (displayItem != null && displayItem.MCC != null)
                {
                    _selectedMCC = displayItem.MCC;
                    MCCListBox.SelectedItem = displayItem;
                    DisplayMCCDetails(_selectedMCC);
                }

                // Notifier MainWindow pour rafra√Æchir la combobox Courriers
                NotifyMainWindowToRefreshCourriers();
            }
            else
            {
                MessageBox.Show(message, "Erreur",
                    MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"[AddToCourriers] Exception: {ex.Message}");
            System.Diagnostics.Debug.WriteLine($"[AddToCourriers] Stack trace: {ex.StackTrace}");
            MessageBox.Show($"Erreur inattendue:\n\n{ex.Message}\n\nVoir les logs pour plus de d√©tails.", "Erreur",
                MessageBoxButton.OK, MessageBoxImage.Error);
        }
    }

    /// <summary>
    /// Retire le MCC s√©lectionn√© de la liste Courriers
    /// </summary>
    private void RemoveFromCourriersList_Click(object sender, RoutedEventArgs e)
    {
        if (_selectedMCC == null)
        {
            MessageBox.Show("Veuillez s√©lectionner un MCC.", "Info",
                MessageBoxButton.OK, MessageBoxImage.Information);
            return;
        }

        var mccId = _selectedMCC.Id; // Sauvegarder l'ID AVANT la confirmation
        var mccName = _selectedMCC.Name;

        var result = MessageBox.Show(
            $"√ätes-vous s√ªr de vouloir retirer '{mccName}' de la liste Courriers ?\n\n" +
            "Le MCC restera dans la biblioth√®que mais n'appara√Ætra plus dans la combobox Courriers.",
            "Confirmer le retrait",
            MessageBoxButton.YesNo,
            MessageBoxImage.Question
        );

        if (result != MessageBoxResult.Yes)
            return;

        var (success, message) = _mccLibrary.RemoveFromCourriersList(mccId);

        if (success)
        {
            MessageBox.Show(message, "Succ√®s",
                MessageBoxButton.OK, MessageBoxImage.Information);

            // Rafra√Æchir l'affichage
            LoadMCCs();

            // Res√©lectionner le MCC en utilisant l'ID sauvegard√©
            var displayItem = _allMCCs.FirstOrDefault(d => d.MCC?.Id == mccId);
            if (displayItem != null && displayItem.MCC != null)
            {
                _selectedMCC = displayItem.MCC;
                MCCListBox.SelectedItem = displayItem;
                DisplayMCCDetails(_selectedMCC);
            }

            // Notifier MainWindow pour rafra√Æchir la combobox Courriers
            NotifyMainWindowToRefreshCourriers();
        }
        else
        {
            MessageBox.Show(message, "Erreur",
                MessageBoxButton.OK, MessageBoxImage.Error);
        }
    }

    /// <summary>
    /// Notifie MainWindow pour rafra√Æchir la combobox Courriers
    /// </summary>
    private void NotifyMainWindowToRefreshCourriers()
    {
        try
        {
            var mainWindow = Application.Current.MainWindow as MainWindow;
            if (mainWindow != null)
            {
                // Appeler une m√©thode sur MainWindow pour rafra√Æchir CourriersControl
                mainWindow.RefreshCourriersTemplates();
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"[MCCLibraryDialog] Erreur rafra√Æchissement Courriers: {ex.Message}");
        }
    }
}

/// <summary>
/// Classe pour l'affichage des MCC dans la liste
/// </summary>
public class MCCDisplayItem
{
    public MCCModel MCC { get; set; } = null!;
    public string Name { get; set; } = string.Empty;
    public string CreatedDisplay { get; set; } = string.Empty;
    public int UsageCount { get; set; }
    public string KeywordsPreview { get; set; } = string.Empty;
    public SemanticAnalysis Semantic { get; set; } = new();
    
    // üÜï Propri√©t√©s de notation
    public double AverageRating { get; set; }
    public int RatingCount { get; set; }
    public string RatingDisplay { get; set; } = string.Empty;
    public string RatingColor { get; set; } = "#999999";
}
